<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webpack Bundle Analysis</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/htmx/2.0.4/htmx.min.js" crossorigin="anonymous"></script>
    <style>
      .hidden-row { display: none; }
      body { padding-top: 0 !important; }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
      ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: #555; }
      .htmx-indicator{ display:none; }
      .htmx-request .htmx-indicator{ display:inline; }
      .htmx-request.htmx-indicator{ display:inline; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto bg-white p-6 rounded-lg shadow-md my-8">
        <h1 class="text-2xl font-bold mb-4 text-gray-800">Webpack Bundle Analysis</h1>
        <p class="text-sm text-gray-600 mb-2">Generated: <span id="generation-time">Loading...</span></p>
        <p class="text-sm text-gray-600 mb-4">Stats file: <span id="stats-file-path">Loading...</span></p> <!-- We might need an API endpoint to fetch this -->

        <!-- Filter Controls with HTMX -->
        <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded flex flex-wrap gap-4 items-center">
             <div class="flex items-center">
                 <label for="minSizeKb" class="text-sm text-gray-700 mr-2">Hide assets <</label>
                 <!-- Default value -->
                 <input type="number" id="minSizeKb" name="minSizeKb" value="1" min="0" step="0.1"
                        class="w-20 px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mr-1"
                        hx-get="/api/table"
                        hx-trigger="input changed delay:500ms, search, load"
                        hx-target="#asset-table-body"
                        hx-include="[name='excludePatterns'], [name='minSizeKb']"
                        hx-indicator="#loading-indicator-table" />
                 <span class="text-sm text-gray-700">KB</span>
            </div>
            <div class="flex-grow min-w-[200px]">
                 <label for="excludePatterns" class="sr-only">Exclude patterns (comma-separated or /regex/)</label>
                 <!-- Default value -->
                 <input type="text" id="excludePatterns" name="excludePatterns" value=""
                        placeholder="Exclude patterns (e.g., node_modules/, .map$)"
                        class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        title="Comma-separated list of strings or /regex/ patterns to exclude"
                        hx-get="/api/table"
                        hx-trigger="input changed delay:500ms, search, load"
                        hx-target="#asset-table-body"
                         hx-include="[name='minSizeKb'], [name='excludePatterns']"
                         hx-indicator="#loading-indicator-table" />
            </div>
            <span id="loading-indicator-table" class="htmx-indicator ml-2 text-sm text-gray-500">Loading Table...</span>
        </div>

        <!-- Warnings container (can be populated by API if needed, or removed) -->
        <div id="warnings-container" class="mb-4"></div>

        <h2 class="text-xl font-semibold mb-3 text-gray-700">Asset Sizes</h2>
        <div class="overflow-auto relative max-h-[70vh] border border-gray-200 rounded">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="sticky top-0 z-10 bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset Name</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visualization</th>
                    </tr>
                </thead>
                <tbody id="asset-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Content loaded via HTMX -->
                    <tr><td colspan="3" class="p-4 text-center text-gray-500">Loading assets...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- Utility Functions (Copied from Backend) ---
        function formatBytes(bytes, decimals = 2) {
            if (!Number.isFinite(bytes) || bytes < 0) return 'N/A';
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.max(0, Math.min(Math.floor(Math.log(bytes) / Math.log(k)), sizes.length - 1));
            return `${Number.parseFloat((bytes / (k ** i)).toFixed(dm))} ${sizes[i]}`;
        }

        // --- Page Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set generation time
            document.getElementById('generation-time').textContent = new Date().toLocaleString();

            // Fetch config and update stats file path display
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    const statsPathElement = document.getElementById('stats-file-path');
                    if (statsPathElement && config.statsFilePath) {
                        statsPathElement.textContent = config.statsFilePath;
                    } else if (statsPathElement) {
                         statsPathElement.textContent = 'Error loading path';
                    }
                })
                .catch(error => {
                    console.error('Error fetching config:', error);
                    const statsPathElement = document.getElementById('stats-file-path');
                    if (statsPathElement) {
                         statsPathElement.textContent = 'Error loading path';
                    }
                });

            // --- LocalStorage Persistence ---
            const minSizeKbInput = document.getElementById('minSizeKb');
            const excludePatternsInput = document.getElementById('excludePatterns');
            const savedMinSizeKb = localStorage.getItem('minSizeKb') || '1';
            const savedExcludePatterns = localStorage.getItem('excludePatterns') || '';

            if (minSizeKbInput) minSizeKbInput.value = savedMinSizeKb;
            if (excludePatternsInput) excludePatternsInput.value = savedExcludePatterns;

            function saveState() {
                if (minSizeKbInput) localStorage.setItem('minSizeKb', minSizeKbInput.value);
                if (excludePatternsInput) localStorage.setItem('excludePatterns', excludePatternsInput.value);
            }

            if (minSizeKbInput) minSizeKbInput.addEventListener('input', saveState);
            if (excludePatternsInput) excludePatternsInput.addEventListener('input', saveState);

            // --- HTMX Table Rendering ---
            const tableBody = document.getElementById('asset-table-body');

            document.body.addEventListener('htmx:afterRequest', function(event) {
                // Check if the request was for our table API and successful
                if (event.detail.target === tableBody && event.detail.successful) {
                    try {
                        const responseData = JSON.parse(event.detail.xhr.responseText);
                        tableBody.innerHTML = ''; // Clear previous content

                        // Check for backend error response
                        if (responseData.error) {
                             tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-red-600">Error: ${responseData.error}</td></tr>`;
                             return;
                        }

                        // Assume responseData is the assets array
                        const assets = responseData;

                        if (!Array.isArray(assets)) {
                             throw new Error("Invalid data format received from API.");
                        }

                        if (assets.length === 0) {
                            tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No assets match filters.</td></tr>`;
                            return;
                        }

                        const maxSize = Math.max(...assets.map(a => a.size ?? 0));
                        let tableHtml = '';

                        assets.forEach(asset => {
                            const sizeBytes = asset.size ?? 0;
                            const formattedSize = formatBytes(sizeBytes);
                            const percentage = maxSize > 0 ? ((sizeBytes / maxSize) * 100).toFixed(1) : 0;
                            tableHtml += `
                                <tr data-size-bytes="${sizeBytes}" data-asset-name="${asset.name}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 break-all">${asset.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${formattedSize}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700" title="${percentage}% of largest asset">
                                          <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });
                        tableBody.innerHTML = tableHtml;

                    } catch (error) {
                        console.error("Error processing table data:", error);
                        tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-red-600">Error rendering table: ${error.message}</td></tr>`;
                    }
                } else if (event.detail.target === tableBody && !event.detail.successful) {
                    // Handle failed HTMX request
                     console.error("HTMX request failed:", event.detail.xhr);
                     tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-red-600">Error loading data (Status: ${event.detail.xhr.status}). Check console.</td></tr>`;
                }
            });

             // Trigger initial load manually if needed (HTMX 'load' trigger might suffice)
             // Ensure inputs have values before triggering
             // setTimeout(() => {
             //    console.log("Triggering initial table load via HTMX.");
             //    htmx.trigger(minSizeKbInput || excludePatternsInput, 'load');
             // }, 50);

        }); // End DOMContentLoaded
    </script>
</body>
</html>
